<div class="error-log-viewer">

    <!-- Header -->
    <div class="viewer-header">
        <h2>üìã –ò—Å—Ç–æ—Ä–∏—è –Ω–∞ –≥—Ä–µ—à–∫–∏—Ç–µ</h2>
        <p class="subtitle">–ü—Ä–µ–≥–ª–µ–¥ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –≤—Å–∏—á–∫–∏ –≥—Ä–µ—à–∫–∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ—Ç–æ</p>
    </div>

    <!-- Statistics Panel -->
    @if (stats$ | async; as stats) {
    <div class="statistics-panel">
        <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value">{{ stats.total }}</div>
                <div class="stat-label">–û–±—â–æ –≥—Ä–µ—à–∫–∏</div>
            </div>
            <div class="stat-card">
                <div class="stat-value text-info">{{ stats.bySeverity[ErrorSeverity.LOW] || 0 }}</div>
                <div class="stat-label">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
            </div>
            <div class="stat-card">
                <div class="stat-value text-warning">{{ stats.bySeverity[ErrorSeverity.MEDIUM] || 0 }}</div>
                <div class="stat-label">–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è</div>
            </div>
            <div class="stat-card">
                <div class="stat-value text-error">{{ stats.bySeverity[ErrorSeverity.HIGH] || 0 }}</div>
                <div class="stat-label">–ì—Ä–µ—à–∫–∏</div>
            </div>
            <div class="stat-card critical">
                <div class="stat-value">{{ stats.bySeverity[ErrorSeverity.CRITICAL] || 0 }}</div>
                <div class="stat-label">–ö—Ä–∏—Ç–∏—á–Ω–∏</div>
            </div>
            <div class="stat-card">
                <div class="stat-value text-success">{{ stats.resolved }}</div>
                <div class="stat-label">–†–µ—à–µ–Ω–∏</div>
            </div>
        </div>
    </div>
    }

    <!-- Filters Section -->
    <div class="filters-section">
        <h3>üîç –§–∏–ª—Ç—Ä–∏</h3>

        <div class="filters-grid">
            <!-- Severity Filter -->
            <div class="filter-group">
                <label>–¢–µ–∂–µ—Å—Ç</label>
                <select class="form-control" [(ngModel)]="selectedSeverity" (change)="onFilterChange()">
                    <option value="all">–í—Å–∏—á–∫–∏</option>
                    @for (option of severityOptions; track option.value) {
                    <option [value]="option.value">{{ option.label }}</option>
                    }
                </select>
            </div>

            <!-- Context Filter -->
            <div class="filter-group">
                <label>–ö–æ–Ω—Ç–µ–∫—Å—Ç</label>
                <select class="form-control" [(ngModel)]="selectedContext" (change)="onFilterChange()">
                    <option value="all">–í—Å–∏—á–∫–∏</option>
                    @for (option of contextOptions; track option.value) {
                    <option [value]="option.value">{{ option.label }}</option>
                    }
                </select>
            </div>

            <!-- Date Range Filters -->
            <div class="filter-group">
                <label>–û—Ç –¥–∞—Ç–∞</label>
                <input type="date" class="form-control" [(ngModel)]="dateFrom" (change)="onFilterChange()">
            </div>

            <div class="filter-group">
                <label>–î–æ –¥–∞—Ç–∞</label>
                <input type="date" class="form-control" [(ngModel)]="dateTo" (change)="onFilterChange()">
            </div>

            <!-- Resolved Filter -->
            <div class="filter-group">
                <label>–°—Ç–∞—Ç—É—Å</label>
                <select class="form-control" [(ngModel)]="filter.resolved" (change)="onFilterChange()">
                    <option [value]="undefined">–í—Å–∏—á–∫–∏</option>
                    <option [value]="false">–ù–µ—Ä–µ—à–µ–Ω–∏</option>
                    <option [value]="true">–†–µ—à–µ–Ω–∏</option>
                </select>
            </div>

            <!-- Search -->
            <div class="filter-group search-group">
                <label>–¢—ä—Ä—Å–µ–Ω–µ</label>
                <input type="text" class="form-control" placeholder="–¢—ä—Ä—Å–∏ –≤ —Å—ä–æ–±—â–µ–Ω–∏—è..."
                    [(ngModel)]="filter.searchText" (input)="onFilterChange()">
            </div>
        </div>

        <!-- Filter Actions -->
        <div class="filter-actions">
            <button class="btn btn-outline btn-sm" (click)="clearFilters()">
                ‚úï –ò–∑—á–∏—Å—Ç–∏ —Ñ–∏–ª—Ç—Ä–∏
            </button>

            <div class="sort-controls">
                <span class="sort-label">–°–æ—Ä—Ç–∏—Ä–∞–Ω–µ:</span>
                <button class="btn btn-outline btn-sm" [class.active]="sortField === 'timestamp'"
                    (click)="changeSortField('timestamp')">
                    üìÖ –í—Ä–µ–º–µ {{ sortField === 'timestamp' ? (sortDirection === 'asc' ? '‚Üë' : '‚Üì') : '' }}
                </button>
                <button class="btn btn-outline btn-sm" [class.active]="sortField === 'severity'"
                    (click)="changeSortField('severity')">
                    ‚ö†Ô∏è –¢–µ–∂–µ—Å—Ç {{ sortField === 'severity' ? (sortDirection === 'asc' ? '‚Üë' : '‚Üì') : '' }}
                </button>
            </div>
        </div>
    </div>

    <!-- Error List -->
    <div class="errors-list">
        @if (filteredErrors$ | async; as errors) {
        @if (errors.length === 0) {
        <div class="empty-state">
            <div class="empty-icon">‚úÖ</div>
            <h3>–ù—è–º–∞ –≥—Ä–µ—à–∫–∏</h3>
            <p>–ù—è–º–∞ –≥—Ä–µ—à–∫–∏, –∫–æ–∏—Ç–æ –¥–∞ –æ—Ç–≥–æ–≤–∞—Ä—è—Ç –Ω–∞ —Ç–µ–∫—É—â–∏—Ç–µ —Ñ–∏–ª—Ç—Ä–∏</p>
        </div>
        } @else {
        <div class="errors-count">
            –ü–æ–∫–∞–∑–∞–Ω–∏ {{ errors.length }} –≥—Ä–µ—à–∫–∏
        </div>

        @for (error of errors; track error.id) {
        <div class="error-row" [class.resolved]="error.resolved" (click)="showErrorDetails(error)">
            <div class="error-row-icon">
                {{ getSeverityIcon(error.severity) }}
            </div>
            <div class="error-row-info">
                <div class="error-row-header">
                    <span class="error-timestamp">{{ formatTimestamp(error.timestamp) }}</span>
                    <span class="severity-badge" [class]="getSeverityClass(error.severity)">
                        {{ error.severity }}
                    </span>
                    <span class="context-badge">{{ error.context }}</span>
                    @if (error.code) {
                    <span class="code-badge">{{ error.code }}</span>
                    }
                    @if (error.resolved) {
                    <span class="resolved-badge">‚úì</span>
                    }
                </div>
                <div class="error-row-message">
                    {{ error.message }}
                </div>
            </div>
            <div class="error-row-actions">
                <button class="btn-icon" (click)="showErrorDetails(error); $event.stopPropagation()" title="–î–µ—Ç–∞–π–ª–∏">
                    üëÅÔ∏è
                </button>
            </div>
        </div>
        }
        }
        }
    </div>

    <!-- Bulk Actions -->
    <div class="bulk-actions">
        <button class="btn btn-outline" (click)="exportLogs()">
            üì• –ï–∫—Å–ø–æ—Ä—Ç–∏—Ä–∞–π –ª–æ–≥–æ–≤–µ
        </button>
        <button class="btn btn-outline" (click)="clearResolvedErrors()">
            üóëÔ∏è –ò–∑—á–∏—Å—Ç–∏ —Ä–µ—à–µ–Ω–∏—Ç–µ
        </button>
        <button class="btn btn-outline btn-danger" (click)="clearAllLogs()">
            üóëÔ∏è –ò–∑—á–∏—Å—Ç–∏ –≤—Å–∏—á–∫–∏
        </button>
    </div>

</div>

<!-- Error Details Modal -->
@if (showDetailsModal && selectedError) {
<div class="modal-overlay" (click)="closeDetailsModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h3>üìã –î–µ—Ç–∞–π–ª–∏ –∑–∞ –≥—Ä–µ—à–∫–∞—Ç–∞</h3>
            <button class="btn-close" (click)="closeDetailsModal()">‚úï</button>
        </div>

        <div class="modal-body">
            <app-error-display [error]="selectedError" [showRetryButton]="true" [showDismissButton]="false"
                [expandedByDefault]="true" (retry)="onRetryError($event)" (resolve)="onResolveError($event)">
            </app-error-display>
        </div>

        <div class="modal-footer">
            <button class="btn btn-outline" (click)="closeDetailsModal()">
                –ó–∞—Ç–≤–æ—Ä–∏
            </button>
            @if (!selectedError.resolved) {
            <button class="btn btn-primary" (click)="onResolveError(selectedError.id)">
                ‚úì –ú–∞—Ä–∫–∏—Ä–∞–π –∫–∞—Ç–æ —Ä–µ—à–µ–Ω–æ
            </button>
            }
        </div>
    </div>
</div>
}