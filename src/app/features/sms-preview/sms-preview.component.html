<div class="sms-preview-container">

    <!-- Header -->
    <div class="preview-header">
        <h2>üìù SMS Preview & Send</h2>
        <p class="subtitle">
            –ü—Ä–µ–≥–ª–µ–¥ –∏ –∏–∑–ø—Ä–∞—â–∞–Ω–µ –Ω–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–∞–Ω–∏ SMS —Å—ä–æ–±—â–µ–Ω–∏—è
        </p>
    </div>

    <!-- No selection message -->
    @if (selectedRecords.length === 0) {
    <div class="card empty-state">
        <div class="empty-icon">üì≠</div>
        <div class="empty-text">–ù—è–º–∞ –∏–∑–±—Ä–∞–Ω–∏ –∫–ª–∏–µ–Ω—Ç–∏</div>
        <p>–ú–æ–ª—è –∏–∑–±–µ—Ä–µ—Ç–µ –∫–ª–∏–µ–Ω—Ç–∏ –æ—Ç —Ç–∞–±–ª–∏—Ü–∞—Ç–∞ –∑–∞ –¥–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞—Ç–µ SMS preview</p>
    </div>
    } @else {

    <!-- Template Editor Section -->
    <div class="template-section card">
        <div class="section-header">
            <h3>üìã SMS –®–∞–±–ª–æ–Ω</h3>
            <button class="btn btn-sm btn-outline" (click)="showPlaceholderHelp()" type="button"
                title="–ü–æ–∫–∞–∂–∏ –Ω–∞–ª–∏—á–Ω–∏ placeholders">
                ‚ùì Placeholders
            </button>
        </div>

        @if (!isEditingTemplate) {
        <!-- View mode -->
        <div class="template-view">
            <div class="template-content">{{ currentTemplate?.content }}</div>
            <button class="btn btn-outline" (click)="toggleTemplateEdit()" type="button">
                ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–∞–π —à–∞–±–ª–æ–Ω
            </button>
        </div>
        } @else {
        <!-- Edit mode -->
        <div class="template-edit">
            <textarea class="form-control template-textarea" rows="6" [(ngModel)]="editedTemplateContent"
                (ngModelChange)="onTemplateContentChange()" placeholder="–í—ä–≤–µ–¥–µ—Ç–µ SMS —à–∞–±–ª–æ–Ω —Å placeholders...">
            </textarea>

            <div class="template-actions">
                <button class="btn btn-primary" (click)="saveTemplateChanges()" type="button">
                    ‚úÖ –ó–∞–ø–∞–∑–∏ –ø—Ä–æ–º–µ–Ω–∏—Ç–µ
                </button>
                <button class="btn btn-outline" (click)="cancelTemplateEdit()" type="button">
                    ‚úï –û—Ç–∫–∞–∑
                </button>
            </div>
        </div>
        }

        <!-- Template Character Count -->
        <div class="char-count-section">
            <div class="char-count-header">
                <span class="char-count-label">Character Count:</span>
                <span class="char-count-value"
                    [class]="getCharCountColor(templateCharCount.count, templateCharCount.encoding)">
                    {{ templateCharCount.count }} chars
                </span>
                <span class="encoding-badge">
                    {{ getEncodingIcon(templateCharCount.encoding) }}
                    {{ getEncodingText(templateCharCount.encoding) }}
                </span>
            </div>

            <div class="char-progress-bar">
                <div class="char-progress-fill"
                    [class]="getCharCountColor(templateCharCount.count, templateCharCount.encoding)"
                    [style.width.%]="getCharProgressPercentage(templateCharCount.count, templateCharCount.encoding)">
                </div>
            </div>

            <div class="char-count-details">
                <span>
                    {{ templateCharCount.estimatedParts }}
                    {{ templateCharCount.estimatedParts === 1 ? '—á–∞—Å—Ç' : '—á–∞—Å—Ç–∏' }}
                </span>
                <span>~{{ templateCharCount.estimatedCost.toFixed(2) }} credits per SMS</span>
            </div>
        </div>
    </div>

    <!-- Preview Section -->
    <div class="preview-section card">
        <div class="section-header">
            <h3>üëÅÔ∏è Preview –Ω–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–∞–Ω–∏ SMS</h3>
            <span class="preview-count">
                –ü–æ–∫–∞–∑–∞–Ω–∏ {{ previewSMS.length }} –æ—Ç {{ personalizedSMS.length }}
            </span>
        </div>

        @if (isGenerating) {
        <div class="loading-state">
            <div class="spinner"></div>
            <p>–ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–∞–Ω–∏ SMS —Å—ä–æ–±—â–µ–Ω–∏—è...</p>
        </div>
        } @else {

        <div class="preview-list">
            @for (sms of previewSMS; track sms.clientId) {
            <div class="sms-card" [class.invalid]="!sms.isValid">
                <div class="sms-header">
                    <div class="client-info">
                        <span class="client-icon">üì±</span>
                        <div class="client-details">
                            <strong>{{ getClientName(sms.clientId) }}</strong>
                            <span class="phone-number">{{ sms.phoneNumber }}</span>
                        </div>
                    </div>
                    <div class="sms-encoding">
                        {{ getEncodingIcon(sms.encoding) }}
                        {{ sms.encoding === 'unicode' ? 'Unicode' : 'Standard' }}
                    </div>
                </div>

                <div class="sms-content">
                    {{ sms.content }}
                </div>

                <div class="sms-footer">
                    <span class="char-count" [class]="getCharCountColor(sms.characterCount, sms.encoding)">
                        {{ sms.characterCount }} chars
                    </span>
                    <span class="parts-count">
                        {{ sms.estimatedParts }}
                        {{ sms.estimatedParts === 1 ? '—á–∞—Å—Ç' : '—á–∞—Å—Ç–∏' }}
                    </span>
                    <span class="cost-estimate">
                        {{ sms.estimatedCost.toFixed(2) }} credits
                    </span>
                </div>

                @if (!sms.isValid && sms.validationErrors) {
                <div class="sms-errors">
                    @for (error of sms.validationErrors; track error) {
                    <div class="error-message">‚ùå {{ error }}</div>
                    }
                </div>
                }
            </div>
            }
        </div>

        @if (hasMoreSMS) {
        <div class="more-sms-notice">
            –ò –æ—â–µ {{ personalizedSMS.length - previewLimit }} SMS —Å—ä–æ–±—â–µ–Ω–∏—è...
        </div>
        }
        }
    </div>

    <!-- Statistics Section -->
    <div class="statistics-section card">
        <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</h3>
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-value">{{ stats.totalRecords }}</div>
                <div class="stat-label">–ò–∑–±—Ä–∞–Ω–∏ –∫–ª–∏–µ–Ω—Ç–∏</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{ stats.totalSMS }}</div>
                <div class="stat-label">–û–±—â–æ SMS</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{ stats.averageChars }}</div>
                <div class="stat-label">–°—Ä–µ–¥–Ω–æ chars</div>
            </div>
            <div class="stat-item success">
                <div class="stat-value">{{ stats.totalCost.toFixed(2) }}</div>
                <div class="stat-label">–û–±—â —Ä–∞–∑—Ö–æ–¥ (credits)</div>
            </div>
        </div>
    </div>

    <!-- Send Button -->
    <div class="send-section">
        <button class="btn btn-primary btn-large" [disabled]="isSending || personalizedSMS.length === 0"
            (click)="sendSMS()" type="button">
            @if (isSending) {
            <span class="spinner-small"></span> –ò–∑–ø—Ä–∞—â–∞–Ω–µ...
            } @else {
            üì® –ò–∑–ø—Ä–∞—Ç–∏ SMS –¥–æ {{ stats.totalRecords }} –∫–ª–∏–µ–Ω—Ç–∞
            }
        </button>
        <p class="send-note">
            –û–±—â —Ä–∞–∑—Ö–æ–¥: <strong>{{ stats.totalCost.toFixed(2) }} credits</strong>
        </p>
    </div>

    }
</div>