<div class="sms-preview-container">

    <!-- Header -->
    <div class="preview-header">
        <h2>üìù SMS Preview & Send</h2>
        <p class="subtitle">
            –ü—Ä–µ–≥–ª–µ–¥ –∏ –∏–∑–ø—Ä–∞—â–∞–Ω–µ –Ω–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–∞–Ω–∏ SMS —Å—ä–æ–±—â–µ–Ω–∏—è
        </p>
    </div>

    <!-- No selection message -->
    @if (selectedRecords.length === 0) {
    <div class="card empty-state">
        <div class="empty-icon">üì≠</div>
        <div class="empty-text">–ù—è–º–∞ –∏–∑–±—Ä–∞–Ω–∏ –∫–ª–∏–µ–Ω—Ç–∏</div>
        <p>–ú–æ–ª—è –∏–∑–±–µ—Ä–µ—Ç–µ –∫–ª–∏–µ–Ω—Ç–∏ –æ—Ç —Ç–∞–±–ª–∏—Ü–∞—Ç–∞ –∑–∞ –¥–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞—Ç–µ SMS preview</p>
    </div>
    } @else {

    <!-- Template Editor Section -->
    <div class="template-section card">
        <div class="section-header">
            <h3>üìã SMS –®–∞–±–ª–æ–Ω</h3>
            <button class="btn btn-sm btn-outline" (click)="showPlaceholderHelp()" type="button"
                title="–ü–æ–∫–∞–∂–∏ –Ω–∞–ª–∏—á–Ω–∏ placeholders">
                ‚ùì Placeholders
            </button>
        </div>

        @if (!isEditingTemplate) {
        <!-- View mode -->
        <div class="template-view">
            <div class="template-content">{{ currentTemplate?.content }}</div>
            <button class="btn btn-outline" (click)="toggleTemplateEdit()" type="button">
                ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–∞–π —à–∞–±–ª–æ–Ω
            </button>
        </div>
        } @else {
        <!-- Edit mode -->
        <div class="template-edit">
            <textarea class="form-control template-textarea" rows="6" [(ngModel)]="editedTemplateContent"
                (ngModelChange)="onTemplateContentChange()" placeholder="–í—ä–≤–µ–¥–µ—Ç–µ SMS —à–∞–±–ª–æ–Ω —Å placeholders...">
            </textarea>

            <div class="template-actions">
                <button class="btn btn-primary" (click)="saveTemplateChanges()" type="button">
                    ‚úÖ –ó–∞–ø–∞–∑–∏ –ø—Ä–æ–º–µ–Ω–∏—Ç–µ
                </button>
                <button class="btn btn-outline" (click)="cancelTemplateEdit()" type="button">
                    ‚úï –û—Ç–∫–∞–∑
                </button>
            </div>
        </div>
        }

        <!-- Template Character Count -->
        <div class="char-count-section">
            <div class="char-count-header">
                <span class="char-count-label">Character Count:</span>
                @if (isTransliterationEnabled) {
                <span class="mode-badge latin">LAT</span>
                } @else {
                <span class="mode-badge cyrillic">CYR</span>
                }
                <span class="char-count-value"
                    [class]="getCharCountColor(templateCharCount.count, templateCharCount.encoding)">
                    {{ templateCharCount.count }} chars
                </span>
                <span class="encoding-badge">
                    {{ getEncodingIcon(templateCharCount.encoding) }}
                    {{ getEncodingText(templateCharCount.encoding) }}
                </span>
            </div>

            <div class="char-progress-bar">
                <div class="char-progress-fill"
                    [class]="getCharCountColor(templateCharCount.count, templateCharCount.encoding)"
                    [style.width.%]="getCharProgressPercentage(templateCharCount.count, templateCharCount.encoding)">
                </div>
            </div>

            <div class="char-count-details">
                <span>
                    {{ templateCharCount.estimatedParts }}
                    {{ templateCharCount.estimatedParts === 1 ? '—á–∞—Å—Ç' : '—á–∞—Å—Ç–∏' }}
                </span>
                <span>~{{ templateCharCount.estimatedCost.toFixed(2) }} credits per SMS</span>
            </div>
        </div>
    </div>

    <!-- Transliteration Toggle Section -->
    <div class="transliteration-toggle-section card">
        <div class="toggle-header">
            <h4>üî§ –†–µ–∂–∏–º –Ω–∞ —Å–∏–º–≤–æ–ª–∏</h4>
            <p class="toggle-description">
                –ò–∑–±–µ—Ä–µ—Ç–µ –¥–∞–ª–∏ SMS-–∏—Ç–µ –¥–∞ —Å–µ –∏–∑–ø—Ä–∞—â–∞—Ç –Ω–∞ –∫–∏—Ä–∏–ª–∏—Ü–∞ (70 —Å–∏–º–≤–æ–ª–∞) –∏–ª–∏ –ª–∞—Ç–∏–Ω–∏—Ü–∞ (160 —Å–∏–º–≤–æ–ª–∞)
            </p>
        </div>

        <div class="toggle-control">
            <label class="toggle-switch">
                <input type="checkbox" [(ngModel)]="isTransliterationEnabled" (change)="toggleTransliteration()" />
                <span class="toggle-slider"></span>
            </label>

            <div class="toggle-labels">
                <span class="toggle-label" [class.active]="!isTransliterationEnabled">
                    üáßüá¨ –ö–∏—Ä–∏–ª–∏—Ü–∞ (70 chars)
                </span>
                <span class="toggle-label" [class.active]="isTransliterationEnabled">
                    üá¨üáß –õ–∞—Ç–∏–Ω–∏—Ü–∞ (160 chars)
                </span>
            </div>
        </div>

        <!-- Info box -->
        <div class="toggle-info" [class.latin-mode]="isTransliterationEnabled">
            @if (isTransliterationEnabled) {
            <span class="info-icon">üí∞</span>
            <span class="info-text">
                –ê–∫—Ç–∏–≤–µ–Ω —Ä–µ–∂–∏–º –õ–ê–¢–ò–ù–ò–¶–ê - –ø–æ-–µ–≤—Ç–∏–Ω–æ –∏–∑–ø—Ä–∞—â–∞–Ω–µ (160 —Å–∏–º–≤–æ–ª–∞/SMS)
            </span>
            } @else {
            <span class="info-icon">‚ÑπÔ∏è</span>
            <span class="info-text">
                –ê–∫—Ç–∏–≤–µ–Ω —Ä–µ–∂–∏–º –ö–ò–†–ò–õ–ò–¶–ê - –æ—Ä–∏–≥–∏–Ω–∞–ª–µ–Ω —Ç–µ–∫—Å—Ç (70 —Å–∏–º–≤–æ–ª–∞/SMS)
            </span>
            }
        </div>
    </div>

    <!-- Errors Section (if any) -->
    @if (showErrorsSection && errorsCount > 0) {
    <div class="errors-section">
        <h3 class="text-error">
            ‚ùå –ì—Ä–µ—à–∫–∏ –ø—Ä–∏ –∏–∑–ø—Ä–∞—â–∞–Ω–µ ({{ errorsCount }})
        </h3>
        <p class="error-subtitle">
            –°–ª–µ–¥–Ω–∏—Ç–µ SMS —Å—ä–æ–±—â–µ–Ω–∏—è –Ω–µ –±—è—Ö–∞ –∏–∑–ø—Ä–∞—Ç–µ–Ω–∏ —É—Å–ø–µ—à–Ω–æ
        </p>

        <div class="errors-list">
            @for (error of smsErrors.values(); track error.clientId) {
            <div class="error-card">
                <div class="error-header">
                    <span class="error-icon">‚ùå</span>
                    <div class="error-info">
                        <strong>{{ error.clientId }}</strong>
                        <span class="error-phone">{{ error.phoneNumber }}</span>
                    </div>
                    @if (error.errorCode) {
                    <span class="error-code-badge">–ö–æ–¥: {{ error.errorCode }}</span>
                    }
                </div>
                <div class="error-message">
                    {{ error.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞ –≥—Ä–µ—à–∫–∞' }}
                </div>
            </div>
            }
        </div>

        <div class="error-actions">
            <button class="btn btn-outline" (click)="clearErrors()">
                ‚úï –°–∫—Ä–∏–π –≥—Ä–µ—à–∫–∏—Ç–µ
            </button>
            @if (lastSendResult && lastSendResult.canRetry) {
            <button class="btn btn-primary" (click)="retrySending(lastSendResult)">
                üîÑ –û–ø–∏—Ç–∞–π –æ—Ç–Ω–æ–≤–æ
            </button>
            }
        </div>
    </div>
    }

    <!-- Preview Section -->
    <div class="preview-section card">
        <div class="section-header">
            <h3>üëÅÔ∏è Preview –Ω–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–∞–Ω–∏ SMS</h3>
            <span class="preview-count">
                –ü–æ–∫–∞–∑–∞–Ω–∏ {{ previewSMS.length }} –æ—Ç {{ personalizedSMS.length }}
            </span>
        </div>

        @if (isGenerating) {
        <div class="loading-state">
            <div class="spinner"></div>
            <p>–ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–∞–Ω–∏ SMS —Å—ä–æ–±—â–µ–Ω–∏—è...</p>
        </div>
        } @else {

        <div class="preview-list">
            @for (sms of previewSMS; track sms.clientId) {
            <div class="sms-card" [class.invalid]="!sms.isValid">
                <div class="sms-header">
                    <div class="client-info">
                        <span class="client-icon">üì±</span>
                        <div class="client-details">
                            <strong>{{ getClientName(sms.clientId) }}</strong>
                            <span class="phone-number">{{ sms.phoneNumber }}</span>
                        </div>

                        @if (hasSMSError(sms.clientId)) {
                        <div class="error-badge" [title]="getSMSError(sms.clientId)?.error || '–ì—Ä–µ—à–∫–∞'"
                            (click)="showErrorDetails(sms.clientId); $event.stopPropagation()">
                            ‚ùå Error
                            @if (getSMSError(sms.clientId)?.errorCode) {
                            <span class="badge-code">{{ getSMSError(sms.clientId)?.errorCode }}</span>
                            }
                        </div>
                        }
                    </div>
                    <div class="sms-encoding">
                        {{ getEncodingIcon(sms.encoding) }}
                        {{ sms.encoding === 'unicode' ? 'Unicode' : 'Standard' }}
                    </div>
                </div>

                <div class="sms-content">
                    {{ sms.content }}
                </div>

                <div class="sms-footer">
                    <span class="char-count" [class]="getCharCountColor(sms.characterCount, sms.encoding)">
                        {{ sms.characterCount }} chars
                    </span>
                    <span class="parts-count">
                        {{ sms.estimatedParts }}
                        {{ sms.estimatedParts === 1 ? '—á–∞—Å—Ç' : '—á–∞—Å—Ç–∏' }}
                    </span>
                    <span class="cost-estimate">
                        {{ sms.estimatedCost.toFixed(2) }} credits
                    </span>
                </div>

                @if (!sms.isValid && sms.validationErrors) {
                <div class="sms-errors">
                    @for (error of sms.validationErrors; track error) {
                    <div class="error-message">‚ùå {{ error }}</div>
                    }
                </div>
                }
            </div>
            }
        </div>

        @if (hasMoreSMS) {
        <div class="more-sms-notice">
            –ò –æ—â–µ {{ personalizedSMS.length - previewLimit }} SMS —Å—ä–æ–±—â–µ–Ω–∏—è...
        </div>
        }
        }
    </div>

    <!-- Statistics Section -->
    <div class="statistics-section card">
        <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</h3>
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-value">{{ stats.totalRecords }}</div>
                <div class="stat-label">–ò–∑–±—Ä–∞–Ω–∏ –∫–ª–∏–µ–Ω—Ç–∏</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{ stats.totalSMS }}</div>
                <div class="stat-label">–û–±—â–æ SMS</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{ stats.averageChars }}</div>
                <div class="stat-label">–°—Ä–µ–¥–Ω–æ chars</div>
            </div>
            <div class="stat-item success">
                <div class="stat-value">{{ stats.totalCost.toFixed(2) }}</div>
                <div class="stat-label">–û–±—â —Ä–∞–∑—Ö–æ–¥ (credits)</div>
            </div>
        </div>
    </div>

    <!-- Send Button -->
    <div class="send-section">
        <button class="btn btn-primary btn-large" [disabled]="isSending || personalizedSMS.length === 0"
            (click)="sendSMS()" type="button">
            @if (isSending) {
            <span class="spinner-small"></span> –ò–∑–ø—Ä–∞—â–∞–Ω–µ...
            } @else {
            üì® –ò–∑–ø—Ä–∞—Ç–∏ SMS –¥–æ {{ stats.totalRecords }} –∫–ª–∏–µ–Ω—Ç–∞
            }
        </button>
        <p class="send-note">
            –û–±—â —Ä–∞–∑—Ö–æ–¥: <strong>{{ stats.totalCost.toFixed(2) }} credits</strong>
        </p>
    </div>

    }

    <!-- Error Details Modal -->
    @if (showErrorDetailsModal && selectedError) {
    <div class="modal-overlay" (click)="closeErrorDetailsModal()">
        <div class="modal-content error-modal" (click)="$event.stopPropagation()">

            <!-- Modal Header -->
            <div class="modal-header">
                <div class="modal-title">
                    <span class="modal-icon">‚ùå</span>
                    <h3>–î–µ—Ç–∞–π–ª–∏ –∑–∞ –≥—Ä–µ—à–∫–∞—Ç–∞</h3>
                </div>
                <button class="btn-close" (click)="closeErrorDetailsModal()" type="button">
                    ‚úï
                </button>
            </div>

            <!-- Modal Body -->
            <div class="modal-body">
                <!-- Use ErrorDisplayComponent -->
                <app-error-display [error]="convertSMSErrorToErrorLog(selectedError)"
                    [showRetryButton]="lastSendResult?.canRetry || false" [showDismissButton]="false"
                    [expandedByDefault]="true" (retry)="onRetryErrorFromDisplay($event)"
                    (resolve)="onResolveErrorFromDisplay($event)">
                </app-error-display>

                <!-- Additional SMS-specific details -->
                <div class="sms-error-details">
                    <h4>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ SMS</h4>

                    <div class="detail-row">
                        <span class="detail-label">–ö–ª–∏–µ–Ω—Ç:</span>
                        <span class="detail-value">{{ selectedError.clientId }}</span>
                    </div>

                    <div class="detail-row">
                        <span class="detail-label">–¢–µ–ª–µ—Ñ–æ–Ω:</span>
                        <span class="detail-value">{{ selectedError.phoneNumber }}</span>
                    </div>

                    @if (selectedError.message) {
                    <div class="detail-row">
                        <span class="detail-label">–°—ä–æ–±—â–µ–Ω–∏–µ:</span>
                        <div class="detail-value message-preview">
                            {{ selectedError.message }}
                        </div>
                    </div>
                    }

                    @if (selectedError.cost) {
                    <div class="detail-row">
                        <span class="detail-label">–û—á–∞–∫–≤–∞–Ω–∞ —Ü–µ–Ω–∞:</span>
                        <span class="detail-value">{{ selectedError.cost.toFixed(2) }} credits</span>
                    </div>
                    }

                    <div class="detail-row">
                        <span class="detail-label">–í—Ä–µ–º–µ:</span>
                        <span class="detail-value">
                            {{ selectedError.timestamp | date:'dd.MM.yyyy HH:mm:ss' }}
                        </span>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="modal-footer">
                <button class="btn btn-outline" (click)="closeErrorDetailsModal()" type="button">
                    –ó–∞—Ç–≤–æ—Ä–∏
                </button>

                @if (lastSendResult && lastSendResult.canRetry) {
                <button class="btn btn-primary"
                    (click)="onRetryErrorFromDisplay(convertSMSErrorToErrorLog(selectedError)); closeErrorDetailsModal()"
                    type="button">
                    üîÑ –û–ø–∏—Ç–∞–π –æ—Ç–Ω–æ–≤–æ –≤—Å–∏—á–∫–∏
                </button>
                }
            </div>

        </div>
    </div>
    }
</div>