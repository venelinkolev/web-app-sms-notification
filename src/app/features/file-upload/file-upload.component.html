<div class="file-upload-container">
    <div class="file-upload-header">
        <h2 class="text-primary">üìÅ –ö–∞—á–≤–∞–Ω–µ –Ω–∞ JSON —Ñ–∞–π–ª</h2>
        <p class="text-secondary">
            –ü—Ä–µ—Ö–≤—ä—Ä–ª–µ—Ç–µ JSON —Ñ–∞–π–ª —Å –∫–ª–∏–µ–Ω—Ç—Å–∫–∏ –¥–∞–Ω–Ω–∏ –∏–ª–∏ —â—Ä–∞–∫–Ω–µ—Ç–µ –∑–∞ –¥–∞ –∏–∑–±–µ—Ä–µ—Ç–µ —Ñ–∞–π–ª
        </p>
    </div>

    <!-- Drag & Drop –∑–æ–Ω–∞ -->
    <div class="file-drop-zone" [class.drag-over]="isDragging" [class.processing]="loadingState.isLoading"
        [class.error]="hasError" (dragover)="onDragOver($event)" (dragleave)="onDragLeave($event)"
        (drop)="onDrop($event)" (click)="openFileDialog()">
        @if (loadingState.isLoading) {
        <div class="upload-state processing">
            <div class="spinner"></div>
            <div class="upload-title">{{ loadingState.message || '–û–±—Ä–∞–±–æ—Ç–≤–∞–Ω–µ –Ω–∞ —Ñ–∞–π–ª...' }}</div>
            @if (loadingState.progress !== undefined) {
            <div class="progress-bar">
                <div class="progress-fill" [style.width.%]="loadingState.progress"></div>
            </div>
            <div class="progress-text">{{ loadingState.progress }}%</div>
            }
        </div>
        } @else if (hasError) {
        <div class="upload-state error">
            <div class="upload-icon">‚ùå</div>
            <div class="upload-title">–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞</div>
            <div class="upload-subtitle">{{ errorMessage }}</div>
            <button class="btn btn-outline" (click)="clearError()" type="button">
                –û–ø–∏—Ç–∞–π—Ç–µ –æ—Ç–Ω–æ–≤–æ
            </button>
        </div>
        } @else if (importResult) {
        <div class="upload-state success">
            <div class="upload-icon">‚úÖ</div>
            <div class="upload-title">–§–∞–π–ª –æ–±—Ä–∞–±–æ—Ç–µ–Ω —É—Å–ø–µ—à–Ω–æ!</div>
            <div class="upload-subtitle">
                {{ importResult.stats.validRecords }} –≤–∞–ª–∏–¥–Ω–∏ –∑–∞–ø–∏—Å–∞ –æ—Ç –æ–±—â–æ {{ importResult.stats.totalRecords }}
            </div>
            <div class="upload-actions">
                <button class="btn btn-primary" (click)="confirmImport()" type="button">
                    –ü—Ä–æ–¥—ä–ª–∂–∏ —Å –æ–±—Ä–∞–±–æ—Ç–µ–Ω–∏—Ç–µ –¥–∞–Ω–Ω–∏
                </button>
                <button class="btn btn-outline" (click)="reset()" type="button">
                    –ö–∞—á–∏ –¥—Ä—É–≥ —Ñ–∞–π–ª
                </button>
            </div>
        </div>
        } @else {
        <div class="upload-state default">
            <div class="upload-icon">
                @if (isDragging) {
                üì§
                } @else {
                üìÅ
                }
            </div>
            <div class="upload-title">
                @if (isDragging) {
                –ü—É—Å–Ω–µ—Ç–µ —Ñ–∞–π–ª–∞ —Ç—É–∫
                } @else {
                –ü—Ä–µ—Ö–≤—ä—Ä–ª–µ—Ç–µ JSON —Ñ–∞–π–ª –∏–ª–∏ —â—Ä–∞–∫–Ω–µ—Ç–µ –∑–∞ –∏–∑–±–æ—Ä
                }
            </div>
            <div class="upload-subtitle">
                –ú–∞–∫—Å–∏–º–∞–ª–µ–Ω —Ä–∞–∑–º–µ—Ä: {{ maxFileSizeFormatted }}
            </div>
        </div>
        }
    </div>

    <!-- File input (—Å–∫—Ä–∏—Ç) -->
    <input #fileInput type="file" accept=".json,application/json" style="display: none"
        (change)="onFileSelected($event)" />

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∑–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∞ -->
    @if (importResult && !loadingState.isLoading) {
    <div class="import-stats">
        <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∑–∞ –∏–º–ø–æ—Ä—Ç–∞</h3>
        <div class="stats-grid">
            <div class="stat-item success">
                <div class="stat-value">{{ importResult.stats.validRecords }}</div>
                <div class="stat-label">–í–∞–ª–∏–¥–Ω–∏ –∑–∞–ø–∏—Å–∞</div>
            </div>
            <div class="stat-item error">
                <div class="stat-value">{{ importResult.stats.invalidRecords }}</div>
                <div class="stat-label">–ù–µ–≤–∞–ª–∏–¥–Ω–∏ –∑–∞–ø–∏—Å–∞</div>
            </div>
            <div class="stat-item info">
                <div class="stat-value">{{ importResult.stats.totalRecords }}</div>
                <div class="stat-label">–û–±—â–æ –∑–∞–ø–∏—Å–∞</div>
            </div>
            <div class="stat-item warning">
                <div class="stat-value">{{ importResult.fileInfo.size | fileSize }}</div>
                <div class="stat-label">–†–∞–∑–º–µ—Ä –Ω–∞ —Ñ–∞–π–ª</div>
            </div>
        </div>

        @if (importResult.invalidRecords.length > 0) {
        <div class="invalid-records">
            <h4 class="text-error">‚ö†Ô∏è –ì—Ä–µ—à–∫–∏ –≤ –∑–∞–ø–∏—Å–∏—Ç–µ</h4>
            <div class="error-list">
                @for (invalid of importResult.invalidRecords.slice(0, 5); track invalid.lineNumber) {
                <div class="error-item">
                    <div class="error-header">
                        <strong>–†–µ–¥ {{ invalid.lineNumber }}:</strong>
                        @if (invalid.record.Number) {
                        <span class="record-number">‚Ññ{{ invalid.record.Number }}</span>
                        }
                        @if (invalid.record.Ime_Firma) {
                        <span class="record-company">{{ invalid.record.Ime_Firma }}</span>
                        }
                    </div>
                    <div class="error-details">
                        {{ invalid.errors.join(', ') }}
                    </div>
                </div>
                }
                @if (importResult.invalidRecords.length > 5) {
                <div class="error-item more">
                    –ò –æ—â–µ {{ importResult.invalidRecords.length - 5 }} –≥—Ä–µ—à–∫–∏...
                </div>
                }
            </div>
        </div>
        }
    </div>
    }
</div>