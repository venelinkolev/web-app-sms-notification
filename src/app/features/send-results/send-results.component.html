<div class="send-results-container">

    <!-- No Results State -->
    @if (!hasResults) {
    <div class="no-results-state">
        <div class="empty-icon">üìä</div>
        <div class="empty-text">–ù—è–º–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏ –æ—Ç –∏–∑–ø—Ä–∞—â–∞–Ω–µ</div>
        <p>–°–ª–µ–¥ –∫–∞—Ç–æ –∏–∑–ø—Ä–∞—Ç–∏—Ç–µ SMS —Å—ä–æ–±—â–µ–Ω–∏—è, —Ç—É–∫ —â–µ –≤–∏–¥–∏—Ç–µ –¥–µ—Ç–∞–π–ª–Ω–∏ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏</p>
    </div>
    }

    <!-- Results Available -->
    @if (hasResults && result) {
    <div class="results-content">

        <!-- Results Header -->
        <div class="results-header">
            <div class="header-left">
                <span class="status-icon">{{ getStatusIcon() }}</span>
                <h2>–†–µ–∑—É–ª—Ç–∞—Ç–∏ –æ—Ç –∏–∑–ø—Ä–∞—â–∞–Ω–µ</h2>
            </div>
            <div class="header-right">
                <span class="status-badge" [ngClass]="getStatusClass()">
                    {{ getStatusText() }}
                </span>
            </div>
        </div>

        <!-- Summary Statistics Panel -->
        <!-- Task 5.3.2: Enhanced with Visual Indicators -->
        <div class="summary-panel card">
            <h3>üìà –û–±—â–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>

            <div class="summary-layout">
                <!-- Left: Stats Grid -->
                <div class="stats-grid">
                    <!-- Total Messages Card -->
                    <div class="stat-card total">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-value">{{ result.stats.totalAttempted }}</div>
                        <div class="stat-label">–û–±—â–æ –æ–ø–∏—Ç–∏</div>
                    </div>

                    <!-- Successful Card -->
                    <div class="stat-card success">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-value">{{ result.stats.successfulCount }}</div>
                        <div class="stat-label">–£—Å–ø–µ—à–Ω–∏</div>
                    </div>

                    <!-- Failed Card -->
                    <div class="stat-card failed">
                        <div class="stat-icon">‚ùå</div>
                        <div class="stat-value">{{ result.stats.failedCount }}</div>
                        <div class="stat-label">–ù–µ—É—Å–ø–µ—à–Ω–∏</div>
                    </div>

                    <!-- Invalid Card -->
                    @if (result.stats.invalidCount > 0) {
                    <div class="stat-card invalid">
                        <div class="stat-icon">‚ö†Ô∏è</div>
                        <div class="stat-value">{{ result.stats.invalidCount }}</div>
                        <div class="stat-label">–ù–µ–≤–∞–ª–∏–¥–Ω–∏</div>
                    </div>
                    }
                </div>

                <!-- Right: Visual Success Rate Indicator -->
                <div class="success-rate-visual">
                    <div class="circular-progress" [ngClass]="getSuccessRateColorClass()">
                        <svg viewBox="0 0 100 100">
                            <!-- Background circle -->
                            <circle cx="50" cy="50" r="40" class="progress-bg" />
                            <!-- Progress circle -->
                            <circle cx="50" cy="50" r="40" class="progress-fill"
                                [style.stroke-dasharray]="getCircleProgressPath(getSuccessRatePercentage())" />
                        </svg>
                        <div class="progress-text">
                            <div class="rate-value">{{ getSuccessRatePercentage() }}%</div>
                            <div class="rate-label">–£—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cost and Metadata -->
            <div class="summary-details">
                <div class="detail-row">
                    <span class="detail-label">üí∞ –û–±—â–∞ —Ü–µ–Ω–∞:</span>
                    <span class="detail-value">{{ formatCost(result.stats.totalCost) }}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">üìä –°—Ä–µ–¥–Ω–∞ —Ü–µ–Ω–∞/SMS:</span>
                    <span class="detail-value">{{ formatCost(getAverageCost()) }}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">‚è±Ô∏è –ü—Ä–æ–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ—Å—Ç:</span>
                    <span class="detail-value">{{ formatDuration(result.metadata.duration) }}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">üïê –í—Ä–µ–º–µ –Ω–∞ –∏–∑–ø—Ä–∞—â–∞–Ω–µ:</span>
                    <span class="detail-value">{{ formatTimestamp(result.metadata.startTime) }}</span>
                </div>
            </div>
        </div>

        <!-- Filters and Search Section -->
        <!-- Task 5.3.3: Enhanced Filtering -->
        <div class="filters-section card">
            <div class="filters-header">
                <h3>üîç –§–∏–ª—Ç—Ä–∏—Ä–∞–Ω–µ –∏ —Ç—ä—Ä—Å–µ–Ω–µ</h3>
                @if (searchText || filterStatus !== 'all') {
                <button class="btn btn-sm btn-outline" (click)="clearFilters()" type="button">
                    ‚úï –ò–∑—á–∏—Å—Ç–∏ —Ñ–∏–ª—Ç—Ä–∏—Ç–µ
                </button>
                }
            </div>

            <div class="filters-controls">
                <!-- Status Filter -->
                <div class="filter-group">
                    <label>–°—Ç–∞—Ç—É—Å</label>
                    <select class="form-control" [(ngModel)]="filterStatus" (change)="onFilterStatusChange()">
                        <option value="all">–í—Å–∏—á–∫–∏ ({{ successfulList.length + failedList.length }})</option>
                        <option value="success">–°–∞–º–æ —É—Å–ø–µ—à–Ω–∏ ({{ successfulList.length }})</option>
                        <option value="failed">–°–∞–º–æ –Ω–µ—É—Å–ø–µ—à–Ω–∏ ({{ failedList.length }})</option>
                    </select>
                </div>

                <!-- Search -->
                <div class="filter-group search-group">
                    <label>–¢—ä—Ä—Å–µ–Ω–µ</label>
                    <input type="text" class="form-control" placeholder="–¢—ä—Ä—Å–∏ –ø–æ –∫–ª–∏–µ–Ω—Ç, —Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ –≥—Ä–µ—à–∫–∞..."
                        [(ngModel)]="searchText" (ngModelChange)="onSearchChange()">
                    @if (searchText) {
                    <button class="clear-search-btn" (click)="searchText = ''; onSearchChange()" type="button">
                        ‚úï
                    </button>
                    }
                </div>

                <!-- Sort Controls -->
                <div class="filter-group">
                    <label>–°–æ—Ä—Ç–∏—Ä–∞–Ω–µ</label>
                    <div class="sort-buttons">
                        <button class="btn btn-sm" [class.active]="sortField === 'client'"
                            (click)="onSortChange('client')" type="button"
                            [title]="'–°–æ—Ä—Ç–∏—Ä–∞–π –ø–æ –∫–ª–∏–µ–Ω—Ç ' + (sortField === 'client' ? (sortDirection === 'asc' ? '(–≤—ä–∑—Ö–æ–¥—è—â–æ)' : '(–Ω–∏–∑—Ö–æ–¥—è—â–æ)') : '')">
                            –ü–æ –∫–ª–∏–µ–Ω—Ç {{ sortField === 'client' ? (sortDirection === 'asc' ? '‚Üë' : '‚Üì') : '' }}
                        </button>
                        <button class="btn btn-sm" [class.active]="sortField === 'phone'"
                            (click)="onSortChange('phone')" type="button"
                            [title]="'–°–æ—Ä—Ç–∏—Ä–∞–π –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω ' + (sortField === 'phone' ? (sortDirection === 'asc' ? '(–≤—ä–∑—Ö–æ–¥—è—â–æ)' : '(–Ω–∏–∑—Ö–æ–¥—è—â–æ)') : '')">
                            –ü–æ —Ç–µ–ª–µ—Ñ–æ–Ω {{ sortField === 'phone' ? (sortDirection === 'asc' ? '‚Üë' : '‚Üì') : '' }}
                        </button>
                        @if (failedList.length > 0) {
                        <button class="btn btn-sm" [class.active]="sortField === 'error'"
                            (click)="onSortChange('error')" type="button"
                            [title]="'–°–æ—Ä—Ç–∏—Ä–∞–π –ø–æ –≥—Ä–µ—à–∫–∞ ' + (sortField === 'error' ? (sortDirection === 'asc' ? '(–≤—ä–∑—Ö–æ–¥—è—â–æ)' : '(–Ω–∏–∑—Ö–æ–¥—è—â–æ)') : '')">
                            –ü–æ –≥—Ä–µ—à–∫–∞ {{ sortField === 'error' ? (sortDirection === 'asc' ? '‚Üë' : '‚Üì') : '' }}
                        </button>
                        }
                    </div>
                </div>
            </div>

            <!-- Results count -->
            <div class="results-count">
                –ü–æ–∫–∞–∑–∞–Ω–∏: <strong>{{ (filterStatus === 'all' ? filteredSuccessList.length + filteredFailedList.length :
                    filterStatus === 'success' ? filteredSuccessList.length : filteredFailedList.length) }}</strong> –æ—Ç
                <strong>{{ successfulList.length + failedList.length }}</strong> —Ä–µ–∑—É–ª—Ç–∞—Ç–∞
            </div>
        </div>

        <!-- Success List Section -->
        <!-- Task 5.3.3: Enhanced with Better Filtering -->
        @if (successfulList.length > 0 && (filterStatus === 'all' || filterStatus === 'success')) {
        <div class="list-section card success-section">
            <div class="list-header" (click)="toggleSuccessList()">
                <h3>
                    <span class="toggle-icon">{{ showSuccessList ? '‚ñº' : '‚ñ∂' }}</span>
                    ‚úÖ –£—Å–ø–µ—à–Ω–æ –∏–∑–ø—Ä–∞—Ç–µ–Ω–∏
                    <span class="count-badge success-badge">{{ filteredSuccessList.length }}</span>
                </h3>
            </div>

            @if (showSuccessList) {
            <div class="list-content" [@listAnimation]>
                @for (item of filteredSuccessList; track item.phoneNumber; let idx = $index) {
                <div class="list-item success-item" [@itemAnimation]="idx">
                    <div class="item-info">
                        <div class="item-client">
                            <span class="client-icon">üë§</span>
                            {{ item.clientId }}
                        </div>
                        <div class="item-phone">üì± {{ item.phoneNumber }}</div>
                        @if (item.cost) {
                        <div class="item-cost">üí∞ {{ item.cost.toFixed(2) }} BGN</div>
                        }
                    </div>
                    <div class="item-timestamp">
                        <span class="time-icon">üïê</span>
                        {{ formatTimestamp(item.timestamp) }}
                    </div>
                </div>
                } @empty {
                <div class="empty-list">
                    <div class="empty-icon">üîç</div>
                    <div class="empty-text">–ù—è–º–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏ —É—Å–ø–µ—à–Ω–∏ —Å—ä–æ–±—â–µ–Ω–∏—è</div>
                </div>
                }
            </div>
            }
        </div>
        }

        <!-- Failed List Section -->
        <!-- Task 5.3.3: Enhanced with Better Filtering and Error Display -->
        @if (failedList.length > 0 && (filterStatus === 'all' || filterStatus === 'failed')) {
        <div class="list-section card failed-section">
            <div class="list-header" (click)="toggleFailedList()">
                <h3>
                    <span class="toggle-icon">{{ showFailedList ? '‚ñº' : '‚ñ∂' }}</span>
                    ‚ùå –ù–µ—É—Å–ø–µ—à–Ω–æ –∏–∑–ø—Ä–∞—Ç–µ–Ω–∏
                    <span class="count-badge failed-badge">{{ filteredFailedList.length }}</span>
                </h3>
                @if (canRetry() && showFailedList) {
                <button class="btn btn-outline btn-sm retry-all-btn"
                    (click)="retryAllFailed(); $event.stopPropagation()" type="button">
                    üîÑ –û–ø–∏—Ç–∞–π –æ—Ç–Ω–æ–≤–æ –≤—Å–∏—á–∫–∏
                    <span class="retry-count">({{ getRetryableCount() }})</span>
                </button>
                }
            </div>

            @if (showFailedList) {
            <div class="list-content" [@listAnimation]>
                @for (item of filteredFailedList; track item.phoneNumber; let idx = $index) {
                <div class="list-item failed-item" [@itemAnimation]="idx">
                    <div class="item-info">
                        <div class="item-client">
                            <span class="client-icon">üë§</span>
                            {{ item.clientId }}
                        </div>
                        <div class="item-phone">üì± {{ item.phoneNumber }}</div>
                        @if (item.error) {
                        <div class="item-error">
                            <span class="error-icon">‚ö†Ô∏è</span>
                            {{ item.error }}
                            @if (item.errorCode) {
                            <span class="error-code">(–ö–æ–¥: {{ item.errorCode }})</span>
                            }
                        </div>
                        }
                    </div>
                    <div class="item-actions">
                        <div class="item-timestamp">
                            <span class="time-icon">üïê</span>
                            {{ formatTimestamp(item.timestamp) }}
                        </div>
                        @if (item.errorCode && canRetry()) {
                        <button class="btn btn-sm btn-outline retry-btn" (click)="retryIndividual(item)" type="button">
                            üîÑ Retry
                        </button>
                        }
                    </div>
                </div>
                } @empty {
                <div class="empty-list">
                    <div class="empty-icon">üîç</div>
                    <div class="empty-text">–ù—è–º–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏ –Ω–µ—É—Å–ø–µ—à–Ω–∏ —Å—ä–æ–±—â–µ–Ω–∏—è</div>
                </div>
                }
            </div>
            }
        </div>
        }

        <!-- Invalid Numbers Section -->
        @if (invalidList.length > 0) {
        <div class="list-section card">
            <div class="list-header">
                <h3>‚ö†Ô∏è –ù–µ–≤–∞–ª–∏–¥–Ω–∏ –Ω–æ–º–µ—Ä–∞ ({{ invalidList.length }})</h3>
            </div>
            <div class="list-content">
                @for (item of invalidList; track item.phoneNumber) {
                <div class="list-item invalid-item">
                    <div class="item-info">
                        <div class="item-client">{{ item.clientId }}</div>
                        <div class="item-phone">üì± {{ item.phoneNumber }}</div>
                        <div class="item-reason">{{ item.reason }}</div>
                    </div>
                </div>
                }
            </div>
        </div>
        }

        <!-- Export Actions -->
        <!-- Task 5.3.5: Will be implemented -->
        <div class="export-section card">
            <h3>üì• –ï–∫—Å–ø–æ—Ä—Ç –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏</h3>
            <div class="export-actions">
                <button class="btn btn-outline" (click)="exportToCSV()" type="button">
                    üìÑ –ï–∫—Å–ø–æ—Ä—Ç CSV
                </button>
                <button class="btn btn-outline" (click)="exportToJSON()" type="button">
                    üìã –ï–∫—Å–ø–æ—Ä—Ç JSON
                </button>
            </div>
        </div>

    </div>
    }

</div>